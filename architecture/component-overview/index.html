<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><link rel=preload href=https://plgd.dev/fonts/muli-latin-200.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://plgd.dev/fonts/muli-latin-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://plgd.dev/fonts/muli-latin-800.woff2 as=font type=font/woff2 crossorigin><meta http-equiv=x-ua-compatible content="IE=edge"><title>Component Overview | plgd</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=robots content="index, follow"><link rel=stylesheet href=/output/css/app.min.bab83909a2f2fe2aa45bf7e4813899f4f705e6858479cea5bd48eee72fdf0a70.css integrity="sha256-urg5CaLy/iqkW/fkgTiZ9PcF5oWEec6lvUju5y/fCnA=" crossorigin=anonymous><meta name=description content="L3 and L4 plgd overview"><script type=text/javascript src=/output/js/app.175b405753a9c0ce86ab35944e9c4cc1a758a6873209cf5106600f6b2f5a59b6.js integrity="sha256-F1tAV1OpwM6GqzWUTpxMwadYpocyCc9RBmAPay9aWbY=" crossorigin=anonymous defer></script><script async defer src=https://buttons.github.io/buttons.js></script><script src=/js/medium-zoom.min.js></script><script src=/js/rawdeflate.js></script><script>window.addEventListener('load',a=>{mediumZoom(document.querySelectorAll('.medium-zoom-image'))})</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png href=/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicon-16x16.png sizes=16x16><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#0594cb><meta name=theme-color content="#ffffff"><meta property="og:title" content="Component Overview"><meta property="og:description" content="L3 and L4 plgd overview"><meta property="og:type" content="article"><meta property="og:url" content="https://plgd.dev/architecture/component-overview/"><meta property="og:image" content="https://plgd.dev/images/plgd-logo-full-white.png"><meta property="article:section" content="architecture"><meta property="article:published_time" content="2021-05-13T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-26T21:43:45+02:00"><meta itemprop=name content="Component Overview"><meta itemprop=description content="L3 and L4 plgd overview"><meta itemprop=datePublished content="2021-05-13T00:00:00+00:00"><meta itemprop=dateModified content="2021-10-26T21:43:45+02:00"><meta itemprop=wordCount content="1713"><meta itemprop=image content="https://plgd.dev/images/plgd-logo-full-white.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://plgd.dev/images/plgd-logo-full-white.png"><meta name=twitter:title content="Component Overview"><meta name=twitter:description content="L3 and L4 plgd overview"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PS70WYYFKX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PS70WYYFKX',{anonymize_ip:!0,dimension1:'plgd.dev',dimension2:''});var trackOutboundLink=function(a,b){gtag('event','click',{event_category:'outbound',event_label:a,transport_type:'beacon'})}</script></head><body class="ma0 sans-serif bg-primary-color-light production"><nav class="bg-primary-color-dark pv4 w-100" role=navigation><div class="center flex-ns flex-wrap items-center justify-start mw9"><h1 class="dim f3 lh-solid ml0-ns mr0 mr4-l mv0 pl3 pl4-ns"><a href=https://plgd.dev/ class="link white plgd-font">plgd</a></h1><ul class="list ma0 pa0 dn dib-l"><li class="f5 dib mr4" role=menuitem><a href=/documentation/ class="dim link light-silver">Docs</a></li><li class="f5 dib mr4" role=menuitem><a href=/news/ class="dim link light-silver">News</a></li><li class="f5 dib mr4" role=menuitem><a href=https://gitter.im/ocfcloud/Lobby/ class="dim link light-silver">Community
<span class=pl1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="10" height="10" viewBox="0 0 32 32" class="fill-current v-base" aria-label="External Link"><path d="M25.152 16.576v5.696q0 2.144-1.504 3.648T20 27.424H5.152q-2.144.0-3.648-1.504t-1.504-3.648V7.424q0-2.112 1.504-3.616t3.648-1.536h12.576q.224.0.384.16t.16.416V4q0 .256-.16.416t-.384.16H5.152q-1.184.0-2.016.832t-.864 2.016v14.848q0 1.184.864 2.016t2.016.864H20q1.184.0 2.016-.864t.832-2.016v-5.696q0-.256.16-.416t.416-.16h1.152q.256.0.416.16t.16.416zM32 1.152v9.12q0 .48-.352.8t-.8.352-.8-.352l-3.136-3.136-11.648 11.648q-.16.192-.416.192t-.384-.192l-2.048-2.048q-.192-.16-.192-.384t.192-.416L24.064 5.088l-3.136-3.136q-.352-.352-.352-.8t.352-.8.8-.352h9.12q.48.0.8.352t.352.8z"/></svg></span></a></li><li class="f5 dib mr4" role=menuitem><a href=https://try.plgd.cloud class="dim link light-silver">Try LIVE
<span class=pl1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="10" height="10" viewBox="0 0 32 32" class="fill-current v-base" aria-label="External Link"><path d="M25.152 16.576v5.696q0 2.144-1.504 3.648T20 27.424H5.152q-2.144.0-3.648-1.504t-1.504-3.648V7.424q0-2.112 1.504-3.616t3.648-1.536h12.576q.224.0.384.16t.16.416V4q0 .256-.16.416t-.384.16H5.152q-1.184.0-2.016.832t-.864 2.016v14.848q0 1.184.864 2.016t2.016.864H20q1.184.0 2.016-.864t.832-2.016v-5.696q0-.256.16-.416t.416-.16h1.152q.256.0.416.16t.16.416zM32 1.152v9.12q0 .48-.352.8t-.8.352-.8-.352l-3.136-3.136-11.648 11.648q-.16.192-.416.192t-.384-.192l-2.048-2.048q-.192-.16-.192-.384t.192-.416L24.064 5.088l-3.136-3.136q-.352-.352-.352-.8t.352-.8.8-.352h9.12q.48.0.8.352t.352.8z"/></svg></span></a></li></ul><div class="db dib-ns pl3"><form id=site-search-form role=search><fieldset class="bn ma0 pa0"><label class=clip for=search-input>Search</label>
<input type=search id=search-input class="needs-js bg-left bn f5 input-reset lh-solid mt3 mt0-ns pl4 pv2 w5 white" placeholder="Search the Docs" name=search-input style="background:url(/images/icon-search.png)5px 11px/16px 16px no-repeat;background-color:rgba(255,255,255,0)"></fieldset></form></div></div></nav><main role=main class="content-with-sidebar min-vh-100 pb7 pb0-ns"><article class="w-100 ph4 pb5 pb6-ns pt1 pt5-ns"><div class=flex-l><div class="order-2 w-100 w-20-l ph5-m ph0-l mb4 sticky"><aside class="fixed-lTK mw5-l right-0 f6 bl-l b--moon-gray pv4 pv0-ns ph4-l nested-list-reset nested-links nested-copy-line-height"><p class=b>What's on this Page</p><nav id=TableOfContents><ul><li><a href=#coap-gateway>CoAP Gateway</a><ul><li><a href=#operational-flow>Operational flow</a></li></ul></li><li><a href=#grpc-gateway>gRPC Gateway</a></li><li><a href=#http-gateway>HTTP Gateway</a></li><li><a href=#resource-aggregate>Resource Aggregate</a><ul><li><a href=#commands-and-events-overview>Commands and Events Overview</a></li></ul></li><li><a href=#resource-directory>Resource Directory</a></li><li><a href=#device>Device</a></li><li><a href=#client>Client</a></li><li><a href=#event-bus>Event Bus</a></li><li><a href=#event-store>Event Store</a></li></ul></nav><div date-pref><a href=https://plgd.dev/architecture/introduction/ class="dib f6 pr1 hover-bg-light-gray br-100" title="Domain Overview"><svg class="fill-current" height="30" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/><path d="M0 0h24v24H0z" fill="none"/></svg></a></div></aside></div><div class="order-1 w-60-l mw7 ph0 ph5-ns mid-gray nested-copy-line-height no-underline nested-links nested-img nested-copy-seperator nested-blockquote mt0-ns" style=flex-grow:1><div class="documentation-copy center measure-wide-l"><div id=readout class="fixed right-0 bottom-0"></div><header class="flex-none w-100"><a href=/categories/architecture class="f6 fw8 mb0 link mid-gray dim mr3">ARCHITECTURE</a>
<a href=/categories/c4-model class="f6 fw8 mb0 link mid-gray dim mr3">C4 MODEL</a>
<a href=/categories/components class="f6 fw8 mb0 link mid-gray dim mr3">COMPONENTS</a><h1 class="lh-title mb3 mv0 pt3 primary-color-dark">Component Overview</h1></header><aside class="bt bw1 pt3 mt2 mid-gray b--mid-gray fn w-100"><div class="f4 fw4 lh-copy">L3 and L4 plgd overview</div></aside><div class=prose id=prose><h2 id=coap-gateway>CoAP Gateway <a class=header-link href=#coap-gateway><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The CoAP gateway acts as a CoAP Client, communicating with IoT devices, which serve as CoAP Servers following the <a href=https://openconnectivity.org/developer/specifications/>OCF specification</a>. As the component diagram describes, the responsibilities of the gateway are:</p><ul><li>Handle and maintain TCP connections coming from devices</li><li><a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=15">Authenticate and authorize requests (see 5.5.5)</a> from the device in conjunction with an OAuth2.0 Server</li><li>Process device CRUDN operations which are by their nature forwarded to the <a href=#resource-aggregate>Resource Aggregate</a> or <a href=#resource-directory>Resource Directory</a></li></ul><p><img src=/images/diagrams/component-coapgateway.svg alt=L3 class=medium-zoom-image></p><h3 id=operational-flow>Operational flow <a class=header-link href=#operational-flow><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Before a device becomes operational and is able to interact with other devices, it needs to be appropriately onboarded. The first step in onboarding the device is to <a href="https://openconnectivity.org/specs/OCF_Security_Specification_v2.2.1.pdf#page=38">configure ownership (see 5.3.3)</a> where the legitimate user who owns/purchases the device uses one of the Owner Transfer Methods (OTMs) within the Onboarding tool to establish ownership. Once ownership is established, the OBT <a href="https://openconnectivity.org/specs/OCF_Security_Specification_v2.2.1.pdf#page=39">provisions the device (see 5.3.4)</a>, after which the device can be <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=32">provisioned for the plgd hub (see 8.1.2.3)</a>. After successful provisioning, the device should <a href="https://openconnectivity.org/specs/OCF_Cloud_Security_Specification_v2.2.1.pdf#page=14">establish a TLS connection (see 7.2)</a> using certificate based credentials.</p><aside class="admonition note"><div class=note-icon></div><div class=admonition-content><p>Use <a href=https://github.com/plgd-dev/device>plgd OCF Client</a> or <a href=https://apps.apple.com/us/app/plgd/id1536315811>Apple</a> / <a href="https://play.google.com/store/apps/details?id=dev.plgd.client">Android</a> mobile app for <strong>easy</strong> device discovery, ownership configuration and provisioning for the plgd hub!</p></div></aside><h4 id=device-onboarding>Device Onboarding <a class=header-link href=#device-onboarding><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><img id=plantuml-device-onboarding class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-device-onboarding");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml Sequence\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant D as \u0022Device\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant IS as \u0022Identity Store\u0022\nparticipant OBT as \u0022Onboarding Tool\u0022\n\nOBT --\u003e[: Discover devices\n|||\nD --\u003e OBT: Here I am\ngroup OCF Onboarding\n    OBT -\u003e D \u002b\u002b: Establish Device Owner\n    return Ownership established\n    OBT -\u003e D \u002b\u002b: Provisioning security configuration\n    return Provisioning successful\nend\ngroup OCF Cloud Provisioning\n    OBT -\u003e D \u002b\u002b: Provisioning cloud configuration resource\n    return Provisioning successful\nend\nD -\u003e CGW \u002b\u002b: Establish TCP connection\n@enduml\n")</script><p>The TCP connection which the device established to the CoAP Gateway is now authenticated, but not authorized. In order for the device to be reachable, the TCP connection must be authorized. This flow describes the operation of a new device; within the first connection the device must Sign Up - <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=33">register with the plgd hub (see 8.1.4)</a>. The <a href=https://tools.ietf.org/html/rfc6749#section-4.1>authorization code</a> received during the OCF Cloud Provisioning process described in the diagram above is exchanged by the CoAP Gateway for an access and refresh token and returned to the device. This process is described in more detail in the <a href="https://openconnectivity.org/specs/OCF_Cloud_Security_Specification_v2.2.1.pdf#page=12">OCF Cloud Security Specification (see 6.2)</a>.</p><h4 id=hub-registration>Hub Registration <a class=header-link href=#hub-registration><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><img id=plantuml-hub-registration class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-hub-registration");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml Sequence\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant D as \u0022Device\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant O as \u0022OAuth 2.0 Server\u0022\nparticipant IS as \u0022Identity Store\u0022\n\nD -\u003e CGW \u002b\u002b: Sign Up\ngroup OAuth2.0 Authorization Code Grant Flow\n    CGW -\u003e O \u002b\u002b: Verify and exchange authorization code for JWT access token\n    return Ok\\n(JWT Access Token, Refresh Token, ...)\nend\nCGW -\u003e IS \u002b\u002b: Register and assign device to user\nreturn Registered\nreturn Signed up\\n(JWT Access Token, Refresh Token, ...)\n@enduml\n")</script><p>Successful registration to plgd.dev is followed by an authorization request called Sign In. Sign In is required right after a successfully established TCP connection to the CoAP Gateway, otherwise the device won’t be reachable – marked as online. Other device requests are blocked as well unless the device successfully Signs In. Successful authorization precedes validation of the <a href=https://tools.ietf.org/html/rfc6749#section-1.4>JWT Access Token</a>.</p><aside class="admonition warning"><div class=admonition-icon></div><div class=admonition-content><p>Only JWT access tokens are supported on the device.</p></div></aside><h4 id=device-authorization>Device Authorization <a class=header-link href=#device-authorization><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><img id=plantuml-device-authorization class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-device-authorization");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml Sequence\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant D as \u0022Device\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant IS as \u0022Identity Store\u0022\nparticipant EB as \u0022Event Bus\u0022\nparticipant RA as \u0022Resource Aggregate\u0022\n\nD -\u003e CGW \u002b\u002b: Sign In\nCGW -\u003e CGW: Validate JWT Access Token\nCGW -\u003e IS \u002b\u002b: Is device registered?\nreturn Ok\nCGW -\u003e EB: Subscribe to device \u0026 owner events\nCGW -\u003e RA \u002b\u002b: Declare device as online\nreturn\nreturn Signed In\n\n@enduml\n")</script><p>Device capabilities are represented in the form of resources. Configuration in terms of whether the resource is published (remotely accessible over plgd hub) or not, is handled by the <a href=https://github.com/iotivity/iotivity-lite/blob/master/include/oc_cloud.h#L128>IoTivity-Lite API</a>. Whether the resource is published is up to the device vendor, who might want to have some resources accessible only on the proximity network. Resource information which is published to the plgd hub provides insights into device capabilities. Clients are interested not only in the resource href - location on which they can request resource representation – but mainly in the resource type, as this allows them to filter only capabilities they are able to control.
As an example, if you have a client application which controls lighting, it will search the Resource Directory for all lights the user has at home – filtering resources by resource type <code>oic.r.switch.binary</code>. Other resources, with data like temperature, moisture, etc. are not of any interest, as the application doesn&rsquo;t understand their representation.
Information which is published doesn&rsquo;t contain resource representation, only resource information as described <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.0.pdf#page=21">here (see 6.1.3.2.2)</a>.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
   <span class=nt>&#34;di&#34;</span><span class=p>:</span><span class=s2>&#34;e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9&#34;</span><span class=p>,</span>
   <span class=nt>&#34;links&#34;</span><span class=p>:[</span>
      <span class=p>{</span>
         <span class=nt>&#34;anchor&#34;</span><span class=p>:</span><span class=s2>&#34;ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9&#34;</span><span class=p>,</span>
         <span class=nt>&#34;href&#34;</span><span class=p>:</span><span class=s2>&#34;/myLightSwitch&#34;</span><span class=p>,</span>
         <span class=nt>&#34;rt&#34;</span><span class=p>:[</span>
            <span class=s2>&#34;oic.r.switch.binary&#34;</span>
         <span class=p>],</span>
         <span class=nt>&#34;if&#34;</span><span class=p>:[</span>
            <span class=s2>&#34;oic.if.a&#34;</span><span class=p>,</span>
            <span class=s2>&#34;oic.if.baseline&#34;</span>
         <span class=p>],</span>
         <span class=nt>&#34;p&#34;</span><span class=p>:{</span>
            <span class=nt>&#34;bm&#34;</span><span class=p>:</span><span class=mi>3</span>
         <span class=p>},</span>
         <span class=nt>&#34;eps&#34;</span><span class=p>:[</span>
            <span class=p>{</span>
               <span class=nt>&#34;ep&#34;</span><span class=p>:</span><span class=s2>&#34;coaps://[fe80::b1d6]:1111&#34;</span><span class=p>,</span>
               <span class=nt>&#34;pri&#34;</span><span class=p>:</span><span class=mi>2</span>
            <span class=p>},</span>
            <span class=p>{</span>
               <span class=nt>&#34;ep&#34;</span><span class=p>:</span><span class=s2>&#34;coaps://[fe80::b1d6]:1122&#34;</span>
            <span class=p>}</span>
         <span class=p>]</span>
      <span class=p>}</span>
   <span class=p>],</span>
   <span class=nt>&#34;ttl&#34;</span><span class=p>:</span><span class=mi>600476</span>
<span class=p>}</span>
</code></pre></div><p>A resource publish request is forwarded to the <a href=#resource-aggregate>Resource Aggregate</a>, which registers a new resource. This process makes the resource discoverable.
The plgd hub starts observation of <strong>every successfully published resource</strong> by sending the <a href=https://tools.ietf.org/html/rfc7641#section-1.2>OBSERVE request</a>. Each of the received notifications from the device is sent to the <a href=#resource-aggregate>Resource Aggregate</a> to record the change.</p><p>As the response to the resource observation request contains actual <a href=https://tools.ietf.org/html/rfc7641#section-1.1>representation</a>, the CoAP Gateway doesn&rsquo;t have to pull the data at all. Additional responses called <a href=https://tools.ietf.org/html/rfc7641#section-3.2>notifications</a> are sent by the device whenever the representation of the device changes.</p><h4 id=resource-publish--subscription>Resource Publish & Subscription <a class=header-link href=#resource-publish--subscription><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><img id=plantuml-resource-publish class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-resource-publish");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml Sequence\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant D as \u0022Device\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant RA as \u0022Resource Aggregate\u0022\n\nD -\u003e CGW \u002b\u002b: Publish Resources\nCGW -\u003e RA \u002b\u002b: Publish Resources\nreturn\nCGW -\u003e D: Observe published resource\nactivate D\nD --\u003e CGW: Resource representation\nCGW -\u003e RA \u002b\u002b: Update resource representation\nreturn\n|||\n[-\u003e D: Actuate\nactivate D\nD --\u003e CGW: Resource representation\ndeactivate D\nCGW -\u003e RA \u002b\u002b: Update resource representation\nreturn\n@enduml\n")</script><p>From this moment on, the device is reachable to all authorized clients and devices. Resource update requests received by a particular Gateway to which the client is connected are forwarded to the <a href=#resource-aggregate>Resource Aggregate</a>. Successful command validation precedes storing and publishing of this event to the <a href=#event-bus>Event Bus</a> to which the CoAP Gateway is subscribed. If the update request event targets the device hosted by this instance of the CoAP Gateway, an <a href=https://tools.ietf.org/html/rfc7252#section-5.8.2>UPDATE</a> is forwarded over the authorized TCP channel to the device. The device response is forwarded to the <a href=#resource-aggregate>Resource Aggregate</a>, which issues a resource updated event, updating the resource projection and informing the client that the update was successful.</p><h4 id=resource-update>Resource Update <a class=header-link href=#resource-update><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><img id=plantuml-resource-update class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-resource-update");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml Sequence\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant D as \u0022Device\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant GGW as \u0022gRPC Gateway\u0022\nparticipant RA as \u0022Resource Aggregate\u0022\nparticipant EB as \u0022Event Bus\u0022\nparticipant C as \u0022Mobile App\u0022\n\nC -\u003e GGW \u002b\u002b: Update device/light resource\nactivate C\nGGW -\u003e RA \u002b\u002b: Update device/light resource\nRA --\u003e EB: Publish ResourceUpdatePending event\nreturn\nEB --\u003e CGW: ResourceUpdatePending event\nactivate CGW\nCGW -\u003e D \u002b\u002b: Update /light resource\nreturn Update successful\nCGW -\u003e RA \u002b\u002b: Update device/light successful\nRA --\u003e EB: Publish ResourceUpdated event\nreturn\ndeactivate CGW\nEB --\u003e GGW: ResourceUpdated event\nreturn Updated\n\n@enduml\n")</script><aside class="admonition note"><div class=note-icon></div><div class=admonition-content><p>A client requesting resource observation will immediately start to receive notifications without additional requests to the device over the CoAP Gateway. As the plgd hub is by default observing the resources of all connected devices, the Gateway responsible will just subscribe to the <a href=#event-bus>Event Bus</a> and forward requested notifications. <strong>Handling of CRUDN operations is the same for every Gateway.</strong></p></div></aside><h4 id=delete-a-device>Delete a device <a class=header-link href=#delete-a-device><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>At some point, a user might want to delete a device from the plgd hub. There are two ways to achieve this.</p><h5 id=disconnect-the-device-from-the-plgd-hub-using-onboarding-tool>Disconnect the device from the plgd hub using Onboarding Tool</h5><p>Through Onboarding Tool, a device is requested to disconnect from the plgd hub and from the local network. There are three steps:</p><ol><li>Send the SignOff message, which deregisters the device</li><li>Close the TCP connection</li><li>Cleanup of the cloud configuration resource</li></ol><h5 id=force-disconnect-by-the-plgd-hub>Force disconnect by the plgd hub</h5><p>A user might decide to delete the device directly using the plgd API. This approach is handy for stale devices, which cannot any longer be requested to disconnect through the Onboarding Tool; thus enabling a clean up of the list of devices in the plgd hub.</p><img id=plantuml-device-delete class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-device-delete");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml\nskinparam backgroundColor transparent\nhide footbox\n\nparticipant C as \u0022Client\u0022\nparticipant GGW as \u0022gRPC Gateway\u0022\nparticipant RA as \u0022Resource Aggregate\u0022\nparticipant IS as \u0022Identity Store\u0022\nparticipant EB as \u0022Event Bus\u0022\nparticipant CGW as \u0022CoAP Gateway\u0022\nparticipant D as \u0022Device\u0022\n\nC -\u003e GGW \u002b\u002b: DeleteDevicesRequest\nGGW -\u003e RA \u002b\u002b: DeleteDevicesRequest\nreturn DeleteDevicesResponse\nGGW -\u003e IS \u002b\u002b: DeleteDevicesRequest\nreturn DeleteDevicesResponse\nIS --\u003e EB: DevicesDeleted\nreturn DeleteDevicesResponse\nEB --\u003e CGW: DevicesDeleted\nCGW -\u003e D: Disconnect\ndestroy D\n\nD -\u003e CGW \u002b\u002b: Sign In\nCGW -\u003e CGW: Validate JWT Access Token\nCGW -\u003e IS \u002b\u002b: Is device registered?\nreturn Not registered\nnote right\n  Revoke Refresh Token\nend note\nreturn Unauthorized\nCGW -\u003e D: Disconnect\ndestroy D\n\nD -\u003e D: Cleanup cloud configuration\n@enduml\n")</script><h2 id=grpc-gateway>gRPC Gateway <a class=header-link href=#grpc-gateway><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><img src=/images/diagrams/component-grpcgateway.svg alt=L3 class=medium-zoom-image></p><h2 id=http-gateway>HTTP Gateway <a class=header-link href=#http-gateway><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><img src=/images/diagrams/component-httpgateway.svg alt=L3 class=medium-zoom-image></p><h2 id=resource-aggregate>Resource Aggregate <a class=header-link href=#resource-aggregate><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Every transaction on the device&rsquo;s resource is scoped to the single <a href=https://martinfowler.com/bliki/DDD_Aggregate.html>aggregate</a> – the Resource Aggregate. The RA builds its internal state, which is a projection of a single fine-grained event stream. When the aggregate receives a new command from any of the plgd gateways, the command is validated and after successful validation an event describing the action is created and persisted in the <a href=#event-store>EventStore</a>. After successful write to the <a href=#event-store>EventStore</a>, the event is published to the <a href=#event-bus>EventBus</a>.</p><blockquote><p>To prevent conflicts during the write to EventStore, the <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>Optimistic concurrency control</a> method is used.</p></blockquote><h3 id=commands-and-events-overview>Commands and Events Overview <a class=header-link href=#commands-and-events-overview><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><img id=plantuml-commands-events-overview class=medium-zoom-image>
<script>function encode64(a){r="";for(i=0;i<a.length;i+=3)i+2==a.length?r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),0):i+1==a.length?r+=append3bytes(a.charCodeAt(i),0,0):r+=append3bytes(a.charCodeAt(i),a.charCodeAt(i+1),a.charCodeAt(i+2));return r}function append3bytes(a,b,c){return c1=a>>2,c2=(a&3)<<4|b>>4,c3=(b&15)<<2|c>>6,c4=c&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(a){return a<10?String.fromCharCode(48+a):(a-=10,a<26)?String.fromCharCode(65+a):(a-=26,a<26)?String.fromCharCode(97+a):(a-=26,a==0)?'-':a==1?'_':'?'}var deflater=window.SharedWorker&&new SharedWorker('/js/rawdeflate.js');deflater?(deflater.port.addEventListener('message',done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker('/js/rawdeflate.js'),deflater.onmessage=done_deflating);function done_deflating(a){const b=document.getElementById("plantuml-commands-events-overview");b.src="https://www.plantuml.com/plantuml/img/"+encode64(a.data)}function compress(a){a=unescape(encodeURIComponent(a)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(a):deflater.postMessage(a):setTimeout(function(){done_deflating({data:deflate(a)})},100)}compress("\n@startuml\nskinparam backgroundColor transparent\n\nleft to right direction\nskinparam usecase {\n    BackgroundColor\u003c\u003c Command \u003e\u003e LightBlue\n    BorderColor\u003c\u003c Command \u003e\u003e LightBlue\n    BackgroundColor\u003c\u003c Event \u003e\u003e LightRed\n    BorderColor\u003c\u003c Event \u003e\u003e DarkRed\n}\n\nusecase (Resource\\nAggregate) as Aggregate\n\n(PublishResourceLinks) \u003c\u003c Command \u003e\u003e\n(UnpublishResourceLinks) \u003c\u003c Command \u003e\u003e\n(RetrieveResource) \u003c\u003c Command \u003e\u003e\n(ConfirmResourceRetrieve) \u003c\u003c Command \u003e\u003e\n(CreateResource) \u003c\u003c Command \u003e\u003e\n(ConfirmResourceCreate) \u003c\u003c Command \u003e\u003e\n(UpdateResource) \u003c\u003c Command \u003e\u003e\n(ConfirmResourceUpdate) \u003c\u003c Command \u003e\u003e\n(DeleteResource) \u003c\u003c Command \u003e\u003e\n(ConfirmResourceDelete) \u003c\u003c Command \u003e\u003e\n(NotifyResourceChanged) \u003c\u003c Command \u003e\u003e\n(CancelPendingCommands) \u003c\u003c Command \u003e\u003e\n(CancelPendingMetadataUpdates) \u003c\u003c Command \u003e\u003e\n\n(ResourceLinksPublished) \u003c\u003c Event \u003e\u003e\n(ResourceLinksUnpublished) \u003c\u003c Event \u003e\u003e\n(ResourceLinksSnapshotTaken) \u003c\u003c Event \u003e\u003e\n(ResourceRetrievePending) \u003c\u003c Event \u003e\u003e\n(ResourceRetrieved) \u003c\u003c Event \u003e\u003e\n(ResourceCreatePending) \u003c\u003c Event \u003e\u003e\n(ResourceCreated) \u003c\u003c Event \u003e\u003e\n(ResourceUpdatePending) \u003c\u003c Event \u003e\u003e\n(ResourceUpdated) \u003c\u003c Event \u003e\u003e\n(ResourceDeletePending) \u003c\u003c Event \u003e\u003e\n(ResourceDeleted) \u003c\u003c Event \u003e\u003e\n(ResourceChanged) \u003c\u003c Event \u003e\u003e\n(ResourceStateSnapshotTaken) \u003c\u003c Event \u003e\u003e\n(DeviceMetadataUpdatePending) \u003c\u003c Event \u003e\u003e\n(DeviceMetadataUpdated) \u003c\u003c Event \u003e\u003e\n(DeviceMetadataSnapshotTaken) \u003c\u003c Event \u003e\u003e\n\n(PublishResourceLinks) -down-\u003e Aggregate\n(UnpublishResourceLinks) -down-\u003e Aggregate\n(RetrieveResource) -down-\u003e Aggregate\n(ConfirmResourceRetrieve) -down-\u003e Aggregate\n(CreateResource) -down-\u003e Aggregate\n(ConfirmResourceCreate) -down-\u003e Aggregate\n(UpdateResource) -down-\u003e Aggregate\n(ConfirmResourceUpdate) -down-\u003e Aggregate\n(DeleteResource) -down-\u003e Aggregate\n(ConfirmResourceDelete) -down-\u003e Aggregate\n(NotifyResourceChanged) -down-\u003e Aggregate\n(CancelPendingCommands) -down-\u003e Aggregate\n(CancelPendingMetadataUpdates) -down-\u003e Aggregate\n\nAggregate -down-\u003e (ResourceLinksPublished)\nAggregate -down-\u003e (ResourceLinksUnpublished)\nAggregate -down-\u003e (ResourceLinksSnapshotTaken)\nAggregate -down-\u003e (ResourceRetrievePending)\nAggregate -down-\u003e (ResourceRetrieved)\nAggregate -down-\u003e (ResourceCreatePending)\nAggregate -down-\u003e (ResourceCreated)\nAggregate -down-\u003e (ResourceUpdatePending)\nAggregate -down-\u003e (ResourceUpdated)\nAggregate -down-\u003e (ResourceDeletePending)\nAggregate -down-\u003e (ResourceDeleted)\nAggregate -down-\u003e (ResourceChanged)\nAggregate -down-\u003e (ResourceStateSnapshotTaken)\nAggregate -down-\u003e (DeviceMetadataUpdatePending)\nAggregate -down-\u003e (DeviceMetadataUpdated)\nAggregate -down-\u003e (DeviceMetadataSnapshotTaken)\n\n@enduml\n")</script><aside class="admonition note"><div class=note-icon></div><div class=admonition-content><p>More detailed flows on which commands trigger which events can be found in the <a href=https://github.com/plgd-dev/hub/blob/main/resource-aggregate/pb/commands.proto>commands proto file</a>.</p></div></aside><p><img src=/images/diagrams/component-resourceaggregate.svg alt=L3 class=medium-zoom-image></p><h2 id=resource-directory>Resource Directory <a class=header-link href=#resource-directory><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><img src=/images/diagrams/component-resourcedirectory.svg alt=L3 class=medium-zoom-image></p><h2 id=device>Device <a class=header-link href=#device><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><img src=/images/diagrams/component-device.svg alt=L3 class=medium-zoom-image></p><h2 id=client>Client <a class=header-link href=#client><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>WIP
<a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=31">8.1.2.2 OCF Cloud User Authorization of Mediator</a></p><p><img src=/images/diagrams/component-clients.svg alt=L3 class=medium-zoom-image></p><h2 id=event-bus>Event Bus <a class=header-link href=#event-bus><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>After every successful write to the <a href=#event-store>EventStore</a>, an event is published on the event bus. Other plgd services are subscribed to the event bus to be notified when a change in the system / on the devices occurs or is requested. One such party is the resource directory, which aggregates resource models in memory for fast retrieve on request by the plgd gateways. Gateways are subscribed also, to enable synchronous processing of devices’ resource updates.</p><p>The plgd hub uses the <a href=https://nats.io>NATS</a> messaging system as its event bus.</p><blockquote><p>We use pure NATS, not NATS Streaming nor Jetstream.</p></blockquote><h2 id=event-store>Event Store <a class=header-link href=#event-store><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The plgd hub persists each resource state mutation as a separate record called an event. This enables us to reconstruct past states, use events as a foundation to understand user behaviour, or even explore a tamper-proof audit log. The plgd hub adopts <a href=https://docs.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Event Sourcing</a> and <a href=https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs>CQRS</a> patterns to support flexibility, scalability and trackability of the system.</p><p>Accepted commands are represented as PendingChange events; resource state changes received from connected devices are represented as ResourceChanged events. All these events are persisted in the EventStore, with the possibility to define your own cleanup policies to remove old events in case they are no longer needed.</p></div><h2>See Also</h2><ul><li><a href=/architecture/system-overview/>System Overview</a></li></ul></div></div><div class="order-0 w-20 dn db-l"><nav role=navigation><ul class="list pa0 nl2"><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.introduction>Introduction</a><ul class="introduction desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/introduction/what-is-plgd/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">What is plgd</a></li><li class="f6 fw4"><a href=/introduction/who-we-are/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Who we are</a></li><li class="f6 fw4"><a href=/introduction/compare-plgd/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Compare plgd</a></li><li class="f6 fw4"><a href=/introduction/faq/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">FAQ</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8 mb1 bb b--moon-gray"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.quickstart>Quickstart</a><ul class="quickstart desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/quickstart/contribute/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Contribute</a></li><li class="f6 fw4"><a href=/quickstart/create-device/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Create device</a></li><li class="f6 fw4"><a href=/quickstart/device-to-device/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Discover & control device locally</a></li><li class="f6 fw4"><a href=/quickstart/device-to-hub/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Control device remotely</a></li><li class="f6 fw4"><a href=/quickstart/deploy-plgd-hub/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Deploy your own plgd hub</a></li><li class="f6 fw4"><a href=/quickstart/create-plgd-app/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Create first plgd application</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.features>Features</a><ul class="features desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/features/audit-log/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Audit Log</a></li><li class="f6 fw4"><a href=/features/pending-command/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Pending command</a></li><li class="f6 fw4"><a href=/features/device-shadow/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Device Shadow</a></li><li class="f6 fw4"><a href=/features/disaster-recovery/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Disaster Recovery</a></li><li class="f6 fw4"><a href=/features/jetstream/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">JetStream</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2 primary-color" data-target=.architecture>Architecture</a><ul class="architecture desktopmenu animated fadeIn list pl0 bg-light-gray db"><li class="f6 fw4"><a href=/architecture/introduction/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Domain Overview</a></li><li class="f6 fw4"><a href=/architecture/component-overview/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 primary-color">Component Overview</a></li><li class="f6 fw4"><a href=/architecture/system-overview/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">System Overview</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.configuration>Configuration</a><ul class="configuration desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/configuration/coap-gateway/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">CoAP Gateway</a></li><li class="f6 fw4"><a href=/configuration/grpc-gateway/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">gRPC Gateway</a></li><li class="f6 fw4"><a href=/configuration/http-gateway/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">HTTP Gateway</a></li><li class="f6 fw4"><a href=/configuration/resource-aggregate/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Resource Aggregate</a></li><li class="f6 fw4"><a href=/configuration/resource-directory/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Resource Directory</a></li><li class="f6 fw4"><a href=/configuration/identity-store/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Identity Store</a></li><li class="f6 fw4"><a href=/configuration/cloud2cloud-gateway/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Cloud2Cloud Gateway</a></li><li class="f6 fw4"><a href=/configuration/cloud2cloud-connector/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Cloud2Cloud Connector</a></li><li class="f6 fw4"><a href=/configuration/certificate-authority/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Certificate Authority</a></li><li class="f6 fw4"><a href=/configuration/oauth-server/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">[MOCK] OAuth Server</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.deployment>Deployment</a><ul class="deployment desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/deployment/k8s/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">plgd on K8S</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8 mb1 bb b--moon-gray"><a href=/device-library/ class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.device-library>Device Library</a></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.developer-guide>Developer Guide</a><ul class="developer-guide desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/developer-guide/advanced-security/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Advanced security</a></li><li class="f6 fw4"><a href=/developer-guide/developing-dashboard/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Dashboard</a></li><li class="f6 fw4"><a href=/developer-guide/testing/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Testing</a></li></ul></li><li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8"><a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.tutorials>Tutorials</a><ul class="tutorials desktopmenu animated fadeIn list pl0 bg-light-gray dn"><li class="f6 fw4"><a href=/tutorials/external-oauth-server/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">External OAuth Server with bundle</a></li><li class="f6 fw4"><a href=/tutorials/shared-ownership/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Share devices within user groups</a></li><li class="f6 fw4"><a href=/tutorials/dashboard-branding/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Branding dashboard</a></li><li class="f6 fw4"><a href=/tutorials/working-with-grpc-client/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Working with gRPC Client</a></li><li class="f6 fw4"><a href=/tutorials/create-delete-device-resources/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">Create & Delete device resources</a></li></ul></li></ul></nav></div></div></article><div class="w-100 bg-light-gray"><div class="mw7 pa4 center nested-lh-copy lh-copy"><h6 class="f4 dark-gray mb2"><a href=https://plgd.dev/architecture/component-overview/ class="hide-child link primary-color"><span class="nl3 child"><svg class="grow" height="14" viewBox="0 0 24 24" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></span>“Component Overview”</a> was last updated: October 26, 2021: <a class="hide-child link primary-color" href=https://github.com/plgd-dev/hub/commit/21f212c94344ccc460a7a9a08f5bd0c354ec6bf3>rename cloud to hub, sdk to device, fix links (#27) (21f212c)</a></h6><a href=https://github.com/plgd-dev/hub/edit/master/content/en/architecture/component-overview.md class="f6 ph3 pv1 br2 dib tc ttu mv3 bg-primary-color white hover-bg-green link">Improve this page</a></div></div></main><footer class="bg-primary-color-dark ph4-ns pt4 relative w-100" role=contentinfo><div class="center flex-ns flex-wrap justify-between mw9 w-90"><div class="pb3 pt1 center"><div class="center w4"><img src=/images/plgd-logo-short-white.svg alt="plgd Logo"></div><ul class="center f6 list ma0 mv3 pa0 tc"><li class="dib mr3"><a href=https://github.com/plgd-dev/hub/issues/new/ class="dim link light-gray pv2">File an Issue</a></li><li class="dib mr3"><a href=https://gitter.im/ocfcloud/Lobby class="dim link light-gray pv2">Discuss Source Code</a></li><li class=dib><a href=https://try.plgd.cloud class="dim link light-gray pv2">Try plgd hub</a></li></ul><div class="center f7 gray tc"> <p class=dib>© plgd.dev 2018–2021</p></div></div></div><div class="bg-primary-color-dark bottom-0 left-0 right-0 dn-l fixed pb3 ph3 pt3 w-100"><div class="globalmenu mobilemenu pb1 dn"><ul class="list hidden dib ph0 scrolling-touch tc"><li class="tl dib ma0 hover-bg-black w-100"><a href=/documentation/ class="ttu f6 link primary-color-light overflow hover-white db brand-font ma0 w-100 pv3 ph4">Docs</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/news/ class="ttu f6 link primary-color-light overflow hover-white db brand-font ma0 w-100 pv3 ph4">News</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=https://gitter.im/ocfcloud/Lobby/ class="ttu f6 link primary-color-light overflow hover-white db brand-font ma0 w-100 pv3 ph4">Community</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=https://try.plgd.cloud class="ttu f6 link primary-color-light overflow hover-white db brand-font ma0 w-100 pv3 ph4">Try LIVE</a></li></ul></div><div class="docsmenu mobilemenu pb1 dn"><ul class="list dib ph0 scrolling-touch tc"><li class="tl dib ma0 hover-bg-black w-100"><a href=/introduction/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Introduction</a></li><li class="tl dib ma0 hover-bg-black w-100 mb2 bb b--mid-gray"><a href=/quickstart/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Quickstart</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/features/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Features</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/architecture/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Architecture</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/configuration/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Configuration</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/deployment/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Deployment</a></li><li class="tl dib ma0 hover-bg-black w-100 mb2 bb b--mid-gray"><a href=/device-library/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Device Library</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/developer-guide/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Developer Guide</a></li><li class="tl dib ma0 hover-bg-black w-100"><a href=/tutorials/ class="ttu f6 link primary-color-light hover-white db brand-font mb1 ma0 w-100 pv2 ph4">Tutorials</a></li></ul></div><div class="flex dn-l justify-between"><button class="js-toggle flex-auto dib dn-l f6 tc db ph3 pv2 link mr2 white bg-primary-color-dark hover-bg-primary-color ba b--white-40 w-auto" data-target=.globalmenu>Menu</button>
<button class="js-toggle flex-auto dib dn-l f6 tc db ph3 pv2 link white bg-primary-color-dark hover-bg-primary-color ba b--white-40 w-auto" data-target=.docsmenu>Docs Menu</button></div></div></footer></body></html>